# Artifact for TAPDance - NDSS '24

This repository contains the code to reproduce the experiments for the paper: `Architecting Trigger-Action Platforms for Security, Performance and Functionality`. The paper's results were obtained by running on a [StarFive VisonFive SBC](https://doc-en.rvspace.org/Doc_Center/visionfive.html) and this repository provides instructions to run the benchmarks on real hardware as well as in an emulated Qemu environment. For conducting the experiments using Qemu, 3 networked machines running Ubuntu 18.04 LTS is required. Building the Docker container needed to run Qemu needs a machine with atleast 30 GB of free space for the docker cache.

The performance claims that are validated by the artifact include:
1. End to End Applet Execution Latency (Section 7.B.3)
2. Applet Execution Latency (Section 7.B.2)
3. Memory Usage of Enclaves (Section 7.B.4)

The functionality claims that are validated by the artifact include:
1. Compilation of 642 out of a total of 682 applets from the minTAP dataset (Section 7, Functionality Evaluation)


## Contents
1. [Pre-Build](#pre-build)
2. [Setting up Trigger Shim](#trigger-shim)
3. [Setting up Action Shim](#action-shim)
4. [Running Spigot Benchmarks on Real Hardware](#spigot)
6. [Building (For Running Compilation Functionality Evaluation)](#compiler)
7. [Running the Compiler Functionality Test using Docker](#compiler-docker)


## Pre-Build (For Running using Qemu and Running on Real H/W) <a name="pre-build"></a>
Provision 2 machines running Ubuntu 18.04 LTS for the trigger and action shims. Both the machines should have a publicly addressable hostname. For artifact evaluation purposes, the authors will be providing these servers.


## Setting up Trigger Shim <a name="trigger-shim"></a>
The trigger shim serves as the source of event data as well as the source of event notification for the applet enclave. The trigger data source is simulated using a python server whereas the event notifications are generated by `wrk` the HTTP performance benchmarking tool.

Clone and build `wrk` on the trigger service machine as follows:

```
git clone https://github.com/deepaksirone/wrk && cd wrk && make
```

Clone and build the trigger service repository on the trigger service machine:

```
git clone https://github.com/deepaksirone/trigger-shim && cd trigger-shim && ./build.sh
```

To run the trigger service serving encrypted trigger data (for Spigot and Spigot without enclaves) run:

```
sudo python3.7 server.py 0.0.0.0 80 --encrypted
```

## Setting up Action Shim <a name="action-shim"></a>
Clone and build the trigger service repository on the trigger service machine:

```
git clone https://github.com/deepaksirone/action-shim && cd action-shim && ./build.sh
```

Run the action service using:

```
sudo python3.7 server.py 0.0.0.0 80
```

## Running Spigot Benchmarks on Real Hardware <a name="spigot"></a>
This subsection assumes access to the StarFive VisionFive SBC (referred to as the board) preloaded with all the benchmark applets at `/home/riscv/artifact_eval`. All the enclave benchmark packages (the 10 chosen for evaluation) are located at `/home/riscv/artifact_eval/benchmarks_prebuilt`. All the files starting with `enc_rule_<TypeScript_fname>.ke` are Spigot applet enclave packages corresponding to the TypeScript applet \<TypeScript_fname\> . All the files starting with `rule_process_<TypeScript_fname>.ke` are Spigot benchmark packages that do not use enclaves. 

The corresponding TypeScript benchmarks are located in the `tap-apps/benchmark_applets` submodule of this repository.

Open a terminal connection to the board and navigate to the artifact directory (`/home/riscv/artifact_eval`):

Load the keystone kernel module:

```
$ sudo insmod keystone-driver.ko
```

Run the time keeping enclave to synchronize the SM time:

```
$ ./ntp_client.ke
```

Start the Keystore by running:

```
$ cd keystore 
$ ./keystore.ke
```

The Keystore will listen on port 7777 on the board. All the benchmark rules are pre-registered with the Keystore.

### Running a Spigot Benchmark (with Enclaves)

Make sure that the trigger and action shims are setup and running. The trigger shim should be running with the `--encrypted` flag. Select the package for a benchmark and run it using 

```
$ sudo ./enc_rule_<TypeScript_fname>.ke > spigot_<TypeScript_fname>.log
```

This will launch the applet enclave which then connects to the keystore to retrieve the keys needed to decrypt the applet. The host process listens on port 80 and waits for event notifications. On receving an event notification (from `wrk`) the applet enclave will fetch encrypted trigger data from the trigger shim, decrypt it and run the applet on it. It then encrypts the results and sends it to the action service

To start sending event notifications, open a terminal to the trigger shim machine and run:

```
$ cd wrk
$ ./wrk -c<num_connections> -t<num_threads> -d10 -s test.lua http://<board_hostname>:80/event_notify/ > spigot_<TypeScript_fname>.<num_connections>_<num_threads>.log
```

where `{(<num_connections>, <num_threads>)} can be {(1, 1), (2, 2), (3, 3)}` (See Figure 5). After every run of `wrk` restart the enclave by Ctrl^C (a few times) followed by:
```
$ sudo ./enc_rule_<TypeScript_fname>.ke
```

Verify that the run worked by checking the logs of the action service.

After every run of `wrk`, statistics of the run are printed which are redirected to `spigot_<TypeScript_fname>.<num_connections>_<num_threads>.log`. The `Requests/sec:` row is taken as the throughput while the `Latency:` under thread stats is taken as the average request latency per run.

### Running a Spigot Benchmark (Without Enclaves)

Make sure that the trigger and action shims are setup and running. The trigger shim should be running with the `--encrypted` flag. Select the package for a benchmark and run it using 

```
$ sudo ./rule_process_<TypeScript_fname>.ke > spigot_base_<TypeScript_fname>.log
```

This will launch the applet enclave which then connects to the keystore to retrieve the keys needed to decrypt the applet. The host process listens on port 80 and waits for event notifications. On receving an event notification (from `wrk`) the applet enclave will fetch encrypted trigger data from the trigger shim, decrypt it and run the applet on it. It then encrypts the results and sends it to the action service

To start sending event notifications, open a terminal to the trigger shim machine and run:

```
$ cd wrk
$ ./wrk -c<num_connections> -t<num_threads> -d10 -s test.lua http://<board_hostname>:80/event_notify/ > spigot_base_<TypeScript_fname>.<num_connections>_<num_threads>.log
```

where `{(<num_connections>, <num_threads>)} can be {(1, 1), (2, 2), (3, 3)}` (See Figure 5). After every run of `wrk` restart the enclave by Ctrl^C (a few times) followed by `$ sudo ./rule_process_<TypeScript_fname>.ke `.

Verify that the run worked by checking the logs of the action service.

After every run of `wrk`, statistics of the run are printed which are redirected to `spigot_base_<TypeScript_fname>.<num_connections>_<num_threads>.log`. The `Requests/sec:` row is taken as the throughput while the `Latency:` under thread stats is taken as the average request latency per run.

### Running the Interpreted Baseline
Make sure that the trigger and action shims are setup and running. The trigger shim should *not* be running with the `--encrypted` flag, start the trigger shim using:

```
sudo python3.7 server.py 0.0.0.0 80
```

`/home/riscv/baseline-tap/server.js` provides the baseline implementation of a NodeJS TAP. All the TypeScript applets are stored at `/home/riscv/baseline-tap/applets`. Line 8 of `server.js` points to the applet that is loaded, edit it to the applet that is going to be run. Lines 27 and 93 correspond to the action and trigger shim URIs respectively, edit them to point to the action and trigger shims respectively.

Run the NodeJS TAP by navigating to `/home/riscv/baseline-tap` and running:

``` 
sudo /home/riscv/nodejs/node-v14.8.0-linux-riscv64/bin/node server.js > tap_baseline_<TypeScript_fname>.log
```

To start sending event notifications, open a terminal to the trigger shim machine and run:

```
$ cd wrk
$ ./wrk -c<num_connections> -t<num_threads> -d10 -s test.lua http://<board_hostname>:80/event_notify/ > tap_baseline_<TypeScript_fname>.<num_connections>_<num_threads>.log
```

where `{(<num_connections>, <num_threads>)} can be {(1, 1), (2, 2), (3, 3)}` (See Figure 5).

After every run of `wrk`, statistics of the run are printed which are redirected to ```spigot_base_<TypeScript_fname>.<num_connections>_<num_threads>.log```. The `Requests/sec:` row is taken as the throughput while the `Latency:` under thread stats is taken as the average request latency per run.


### Memory Usage of Enclaves

When running an enclave package, check for the line `Requesting n pages from the kernel`. Here n is the total number of pages used by the enclave. Multiply that by the page size (4096) to get the total memory usage of an enclave.

### Memory Usage of NodeJS Baseline

When `server.js` is launched, the `rss` field that is printed out shows the resident set size of the NodeJS interpreter.

### Applet Execution Time

`spigot_<TypeScript_fname>.log` and `spigot_base_<TypeScript_fname>.log` have an "Enclave Exec time: " field that can be averaged to find the average execution time of an enclave execution for spigot with and without enclaves respectively. `tap_baseline_<TypeScript_fname>.log` has an "applet_exec_time" that can be averaged to find the applet execution time.

## Building (For Running Compilation Functionality Evaluation) <a name="compiler"></a>
Clone the repository on the build machine using:
```
git clone https://github.com/multifacet/tap_artifact
```

**Warning** Building the docker container requires atleast 30 GB of free space in the local docker cache. Install docker following the [instructions](https://docs.docker.com/engine/install/) for the build machine's distro.

**The build step takes 40-60 minutes**

Build the Qemu docker container using:

```
docker build --build-arg triggerHostname=<trigger_hostname> --build-arg triggerPort=80 --build-arg actionHostname=<action_hostname> --build-arg actionPort=80 -t dsirone/tapdance:latest .
```

This will build the Qemu container having all the benchmark applet enclaves configured to pull data from the trigger service and push data to the action service.


## Running the Compiler Functionality Test using Docker <a name="compiler-docker"></a>

This step assumes that you have built the Qemu docker container in the previous step. Run the docker container using:

``` 
docker run --rm -it -p 7022:7022 -p 7080:7080 -p 7777:7777 dsirone/tapdance:latest bash 
```

Navigate to the applets repo and run the applet compilation test script:

```
$ cd /build/tap-apps
$ ./check_applets.sh $(pwd)/all_applets
```

This will try to compile all the applets into LLVM IR using [StaticScript](https://github.com/deepaksirone/StaticScript) and print out the resulting statistics
